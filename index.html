<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Layout Tool / Strumento di Layout Classe</title>

    <!-- CSS STYLES -->
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --secondary-bg: #ffffff;
            --border-color: #d1d9e6;
            --primary-text: #333;
            --accent-color: #007bff;
            --desk-bg: #eef2f9;
            --danger-color: #dc3545;
        }

        /* --- General Setup --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        body.dragging {
            user-select: none;
        }

        /* --- Modals (Language, Selection, Student) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--secondary-bg); padding: 40px; border-radius: 12px;
            text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%; width: 500px; position: relative;
        }
        #student-modal .modal-content { text-align: left; width: 400px; }
        
        .choice-group { display: flex; gap: 20px; margin-top: 20px; justify-content: center; }
        .close-button {
            position: absolute; top: 10px; right: 15px; font-size: 28px;
            font-weight: bold; cursor: pointer; color: #aaa;
        }
        
        /* --- Main App Structure --- */
        .app-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 1400px; margin: auto; }
        
        /* Configuration Panels */
        .config-panel { background-color: var(--secondary-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .config-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .config-header h3 { margin: 0; }
        .input-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: center; }
        .input-group label { font-weight: 500; }
        .input-group input[type="number"] { width: 60px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        #row-inputs-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; border-left: 3px solid var(--accent-color); padding-left: 15px; }

        /* Classroom Container & Desk Styles */
        #classroom-container-parent { background-color: var(--secondary-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; }
        #classroom { 
            display: grid; grid-template-columns: 110px 1fr 110px; grid-template-rows: auto 1fr auto;
            width: 100%; max-width: 1200px; min-height: 70vh; margin: auto; background-color: #fffbe8;
            border: 2px solid #333; position: relative;
        }
        .wall { display: flex; justify-content: center; align-items: center; }
        .top-wall { grid-column: 1 / 4; grid-row: 1; padding: 15px; gap: 10px; flex-wrap: wrap; }
        .left-wall, .right-wall { grid-row: 2; flex-direction: column; justify-content: flex-start; gap: 15px; }
        .left-wall { grid-column: 1; padding-top: 10px; }
        .right-wall { grid-column: 3; padding-top: 0; }
        .bottom-wall { grid-column: 1 / 4; grid-row: 3; }
        .center-area { grid-column: 2; grid-row: 2; display: flex; justify-content: center; align-items: flex-end; }
        #teacher-desk { width: 100px; height: 50px; background-color: #a47449; color: white; display: flex; justify-content: center; align-items: center; border-radius: 5px; border: 2px solid #6b4b2c; }
        
        #standard-layout-area { display: flex; flex-direction: column; gap: 20px; align-items: center; padding: 20px; background-color: #fffbe8; min-height: 70vh; border: 2px solid #333; border-radius: 12px; }
        .desk-row { display: flex; justify-content: center; gap: 15px; }
        
        .desk-pair { display: flex; gap: 4px; padding: 4px; background-color: #e0dcd1; border-radius: 5px; }
        .left-wall .desk-pair, .right-wall .desk-pair { flex-direction: column; }
        
        .student-station {
            width: 50px; height: 50px; background-color: var(--desk-bg); border: 1px solid var(--border-color); cursor: pointer;
            display: flex; justify-content: center; align-items: center; text-align: center;
            overflow: hidden; position: relative; background-size: cover; background-position: center;
            transition: border-color 0.2s;
        }
        .student-name { position: absolute; bottom: 1px; left: 0; right: 0; background-color: rgba(255, 255, 255, 0.75); padding: 1px 0; font-weight: bold; font-size: 10px; }
        .student-station.drag-over { border-color: #28a745; border-width: 2px; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #classroom { display: flex; flex-direction: column; height: auto; min-height: 80vh; gap: 20px; }
            .wall { flex-wrap: wrap; }
            .left-wall .desk-pair, .right-wall .desk-pair { flex-direction: row; }
        }
    </style>
</head>
<body>

    <!-- 1. Language Selection Screen -->
    <div id="language-modal" class="modal">
        <div class="modal-content">
            <h2>Choose Language / Scegli la Lingua</h2>
            <div class="choice-group">
                <button id="select-lang-en" class="btn btn-primary">English</button>
                <button id="select-lang-it" class="btn btn-primary">Italiano</button>
            </div>
        </div>
    </div>

    <!-- 2. Classroom Type Selection Screen -->
    <div id="selection-modal" class="modal hidden">
        <div class="modal-content">
            <h2 data-translate="chooseLayout">Choose a Classroom Layout</h2>
            <div class="choice-group">
                <button id="select-parliament" class="btn btn-primary" data-translate="parliament">Parliament</button>
                <button id="select-standard" class="btn btn-primary" data-translate="standard">Standard</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <main class="app-container hidden" id="main-app">
        <!-- Configuration Panels -->
        <div class="config-panel hidden" id="parliament-config">
            <div class="config-header">
                <h3 data-translate="parliamentConfig">Parliament Layout Configuration</h3>
                <button id="change-lang-1" class="btn btn-secondary" data-translate="changeLang">Change Language</button>
            </div>
            <div class="input-group">
                <div><label data-translate="topWall">Top Wall (Pairs):</label><input type="number" id="wall1-desks" value="7" min="0"></div>
                <div><label data-translate="leftWall">Left Wall (Pairs):</label><input type="number" id="wall2-desks" value="3" min="0"></div>
                <div><label data-translate="rightWall">Right Wall (Pairs):</label><input type="number" id="wall3-desks" value="4" min="0"></div>
            </div>
            <button id="reset-data-btn1" class="btn btn-danger" data-translate="resetAll">Reset All Data</button>
        </div>
        <div class="config-panel hidden" id="standard-config">
            <div class="config-header">
                <h3 data-translate="standardConfig">Standard Layout Configuration</h3>
                <button id="change-lang-2" class="btn btn-secondary" data-translate="changeLang">Change Language</button>
            </div>
            <div class="input-group"><label data-translate="totalRows">Total rows:</label><input type="number" id="total-rows" value="3" min="1"></div>
            <div id="row-inputs-container"></div>
            <button id="reset-data-btn2" class="btn btn-danger" data-translate="resetAll">Reset All Data</button>
        </div>

        <div id="classroom-container-parent"><div id="classroom-container"></div></div>
    </main>

    <!-- Student Info Modal -->
    <div id="student-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 data-translate="studentInfo">Student Information</h3>
            <form id="student-form" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="hidden" id="station-id-input">
                <div><label for="student-name" data-translate="name">Name:</label><input type="text" id="student-name"></div>
                <div><label for="student-photo" data-translate="photo">Photo:</label><input type="file" id="student-photo" accept="image/*"></div>
                <div><label for="student-info" data-translate="notes">Notes:</label><textarea id="student-info" rows="3"></textarea></div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <button type="button" id="remove-student-btn" class="btn btn-danger" data-translate="removeStudent">Remove Student</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- TRANSLATION DATA ---
            const translations = {
                en: {
                    chooseLayout: "Choose a Classroom Layout",
                    parliament: "Parliament",
                    standard: "Standard",
                    parliamentConfig: "Parliament Layout Configuration",
                    standardConfig: "Standard Layout Configuration",
                    changeLang: "Change Language",
                    topWall: "Top Wall (Pairs):",
                    leftWall: "Left Wall (Pairs):",
                    rightWall: "Right Wall (Pairs):",
                    totalRows: "Total rows:",
                    desksInRow: "Desks (Pairs) in Row",
                    resetAll: "Reset All Data",
                    studentInfo: "Student Information",
                    name: "Name:",
                    photo: "Photo:",
                    notes: "Notes:",
                    removeStudent: "Remove Student",
                    save: "Save",
                    teacherDesk: "Cattedra",
                    emptySeat: "Empty Seat",
                    resetConfirm: "Are you sure? This will delete all saved layouts and student information.",
                },
                it: {
                    chooseLayout: "Scegli un Layout per la Classe",
                    parliament: "Parlamento",
                    standard: "Standard",
                    parliamentConfig: "Configurazione Layout Parlamento",
                    standardConfig: "Configurazione Layout Standard",
                    changeLang: "Cambia Lingua",
                    topWall: "Fila Superiore (Banchi):",
                    leftWall: "Fila Sinistra (Banchi):",
                    rightWall: "Fila Destra (Banchi):",
                    totalRows: "Numero di file:",
                    desksInRow: "Banchi nella Fila",
                    resetAll: "Resetta Tutti i Dati",
                    studentInfo: "Informazioni Studente",
                    name: "Nome:",
                    photo: "Foto:",
                    notes: "Note:",
                    removeStudent: "Rimuovi Studente",
                    save: "Salva",
                    teacherDesk: "Cattedra",
                    emptySeat: "Posto Vuoto",
                    resetConfirm: "Sei sicuro? Questo eliminerÃ  tutti i layout e le informazioni sugli studenti salvate.",
                }
            };

            // --- DOM Element References ---
            const languageModal = document.getElementById('language-modal');
            const selectionModal = document.getElementById('selection-modal');
            const mainApp = document.getElementById('main-app');
            const classroomContainer = document.getElementById('classroom-container');
            const studentModal = document.getElementById('student-modal');
            const parliamentConfigPanel = document.getElementById('parliament-config');
            const standardConfigPanel = document.getElementById('standard-config');
            const wallInputs = [document.getElementById('wall1-desks'), document.getElementById('wall2-desks'), document.getElementById('wall3-desks')];
            const totalRowsInput = document.getElementById('total-rows');
            const rowInputsContainer = document.getElementById('row-inputs-container');
            
            // --- State Management ---
            let appData = {}; // Holds all data
            let currentLang = 'en';
            let draggedStationId = null;
            let isDragging = false;

            // --- MAIN INITIALIZATION ---
            function init() {
                const savedLang = localStorage.getItem('classroomLang');
                const savedData = localStorage.getItem('classroomData');

                if (savedLang) {
                    currentLang = savedLang;
                    languageModal.classList.add('hidden');
                    if (savedData) {
                        appData = JSON.parse(savedData);
                        selectionModal.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        loadLayoutFromData();
                    } else {
                        selectionModal.classList.remove('hidden');
                    }
                } else {
                    languageModal.classList.remove('hidden');
                }
                addGlobalEventListeners();
                translateUI();
            }

            // --- LANGUAGE & TRANSLATION ---
            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('classroomLang', lang);
                translateUI();
                languageModal.classList.add('hidden');
                if (!appData.layoutType) { // Show layout selection if not already chosen
                    selectionModal.classList.remove('hidden');
                }
            }

            function translateUI() {
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    if (translations[currentLang][key]) {
                        el.textContent = translations[currentLang][key];
                    }
                });
                // Also update dynamic elements if they exist
                populateStudentData(); 
            }

            function addGlobalEventListeners() {
                // Language
                document.getElementById('select-lang-en').addEventListener('click', () => setLanguage('en'));
                document.getElementById('select-lang-it').addEventListener('click', () => setLanguage('it'));
                document.getElementById('change-lang-1').addEventListener('click', () => languageModal.classList.remove('hidden'));
                document.getElementById('change-lang-2').addEventListener('click', () => languageModal.classList.remove('hidden'));

                // Layout Selection
                document.getElementById('select-parliament').addEventListener('click', () => setupLayout('parliament'));
                document.getElementById('select-standard').addEventListener('click', () => setupLayout('standard'));

                // Reset Buttons
                document.getElementById('reset-data-btn1').addEventListener('click', resetAllData);
                document.getElementById('reset-data-btn2').addEventListener('click', resetAllData);
                
                // Config Inputs
                wallInputs.forEach(input => input.addEventListener('input', () => generateLayout('parliament', false)));
                totalRowsInput.addEventListener('input', () => {
                    updateRowInputs();
                    generateLayout('standard', false);
                });

                // Student Modal
                studentModal.querySelector('.close-button').addEventListener('click', () => studentModal.classList.add('hidden'));
                document.getElementById('student-form').addEventListener('submit', handleSaveStudent);
                document.getElementById('remove-student-btn').addEventListener('click', handleRemoveStudent);
            }
            
            // --- DATA & STATE FUNCTIONS ---
            function saveData() {
                const existingDeskIds = new Set((appData.config.desks || []).map(d => d.id));
                const filteredStudentData = {};
                for (const studentId in appData.studentData) {
                    if (existingDeskIds.has(studentId)) filteredStudentData[studentId] = appData.studentData[studentId];
                }
                appData.studentData = filteredStudentData;
                localStorage.setItem('classroomData', JSON.stringify(appData));
            }

            function resetAllData() {
                if (confirm(translations[currentLang].resetConfirm)) {
                    localStorage.removeItem('classroomData');
                    localStorage.removeItem('classroomLang'); // Also reset language
                    window.location.reload();
                }
            }
            
            // --- LAYOUT SETUP & GENERATION ---
            function loadLayoutFromData() {
                if (appData.layoutType === 'parliament') {
                    parliamentConfigPanel.classList.remove('hidden');
                    wallInputs[0].value = appData.config.wall1;
                    wallInputs[1].value = appData.config.wall2;
                    wallInputs[2].value = appData.config.wall3;
                } else {
                    standardConfigPanel.classList.remove('hidden');
                    totalRowsInput.value = appData.config.totalRows;
                    updateRowInputs();
                    document.querySelectorAll('.row-desk-input').forEach((input, index) => {
                        input.value = appData.config.rows[index];
                    });
                }
                generateLayout(appData.layoutType, false);
            }

            function setupLayout(type) {
                selectionModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                generateLayout(type, true);
            }

            function generateLayout(type, isFresh) {
                if (isFresh) {
                    appData = { layoutType: type, config: {}, studentData: {} };
                }
                appData.config.desks = [];
                classroomContainer.innerHTML = '';
                let stationCounter = 0;

                if (type === 'parliament') {
                    parliamentConfigPanel.classList.remove('hidden');
                    standardConfigPanel.classList.add('hidden');
                    classroomContainer.id = 'classroom';
                    
                    const [w1, w2, w3] = wallInputs.map(input => parseInt(input.value) || 0);
                    appData.config = { wall1: w1, wall2: w2, wall3: w3, desks: [] };

                    const topWall = createWall('top-wall');
                    for (let i = 0; i < w1; i++) topWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    const leftWall = createWall('left-wall');
                    for (let i = 0; i < w2; i++) leftWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    const rightWall = createWall('right-wall');
                    for (let i = 0; i < w3; i++) rightWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    
                    classroomContainer.append(topWall, leftWall, rightWall, createWall('center-area', `<div id="teacher-desk">${translations[currentLang].teacherDesk}</div>`), createWall('bottom-wall'));

                } else {
                    standardConfigPanel.classList.remove('hidden');
                    parliamentConfigPanel.classList.add('hidden');
                    classroomContainer.id = 'standard-layout-area';
                    
                    const rowInputs = document.querySelectorAll('.row-desk-input');
                    appData.config = { totalRows: rowInputs.length, rows: [], desks: [] };

                    rowInputs.forEach(input => {
                        const deskPairCount = parseInt(input.value) || 0;
                        appData.config.rows.push(deskPairCount);
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'desk-row';
                        for (let i = 0; i < deskPairCount; i++) rowDiv.appendChild(createDeskPair(stationCounter++, stationCounter++));
                        classroomContainer.appendChild(rowDiv);
                    });
                }

                appData.config.desks = Array.from(document.querySelectorAll('.student-station')).map(station => ({ id: station.id }));
                populateStudentData();
                attachDeskListeners();
                saveData();
            }

            function updateRowInputs() {
                const rowCount = parseInt(totalRowsInput.value) || 1;
                rowInputsContainer.innerHTML = '';
                for (let i = 1; i <= rowCount; i++) {
                    const div = document.createElement('div');
                    div.innerHTML = `<label>${translations[currentLang].desksInRow} ${i}:</label><input type="number" class="row-desk-input" value="4" min="0">`;
                    rowInputsContainer.appendChild(div);
                }
                document.querySelectorAll('.row-desk-input').forEach(input => input.addEventListener('input', () => generateLayout('standard', false)));
            }

            // --- Element Creation & Data Population ---
            function createWall(className, innerHTML = '') {
                const wall = document.createElement('div');
                wall.className = `wall ${className}`;
                wall.innerHTML = innerHTML;
                return wall;
            }
            function createDeskPair(id1, id2) {
                const pair = document.createElement('div');
                pair.className = 'desk-pair';
                pair.appendChild(createStudentStation(id1));
                pair.appendChild(createStudentStation(id2));
                return pair;
            }
            function createStudentStation(id) {
                const station = document.createElement('div');
                station.className = 'student-station';
                station.id = `station-${id}`;
                return station;
            }

            function populateStudentData() {
                const studentData = appData.studentData || {};
                document.querySelectorAll('.student-station').forEach(station => {
                    const data = studentData[station.id];
                    station.innerHTML = '';
                    station.style.backgroundImage = '';
                    if (data && data.name) {
                        if (data.photo) station.style.backgroundImage = `url(${data.photo})`;
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'student-name';
                        nameDiv.textContent = data.name;
                        station.appendChild(nameDiv);
                    } else {
                         const nameDiv = document.createElement('div');
                         nameDiv.className = 'student-name';
                         nameDiv.textContent = translations[currentLang].emptySeat;
                         station.appendChild(nameDiv);
                    }
                });
            }

            function attachDeskListeners() {
                document.querySelectorAll('.student-station').forEach(station => {
                    station.addEventListener('click', handleStationClick);
                    station.addEventListener('mousedown', handleDragStart);
                    station.addEventListener('mouseover', handleDragOver);
                    station.addEventListener('mouseout', handleDragOut);
                    document.addEventListener('mouseup', handleDrop); // Listen on document for robustness
                });
            }
            
            // --- Event Handlers (Student Interaction) ---
            function handleStationClick(e) {
                if (isDragging) return;
                const stationId = e.currentTarget.id;
                const data = appData.studentData[stationId] || {};
                document.getElementById('station-id-input').value = stationId;
                document.getElementById('student-name').value = data.name || '';
                document.getElementById('student-info').value = data.info || '';
                document.getElementById('student-photo').value = '';
                studentModal.classList.remove('hidden');
            }

            function handleSaveStudent(e) {
                e.preventDefault();
                const stationId = document.getElementById('station-id-input').value;
                const photoFile = document.getElementById('student-photo').files[0];
                const studentInfo = {
                    name: document.getElementById('student-name').value.trim(),
                    info: document.getElementById('student-info').value.trim(),
                    photo: (appData.studentData[stationId] || {}).photo
                };
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        studentInfo.photo = event.target.result;
                        appData.studentData[stationId] = studentInfo;
                        saveData();
                        populateStudentData();
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    appData.studentData[stationId] = studentInfo;
                    saveData();
                    populateStudentData();
                }
                studentModal.classList.add('hidden');
            }

            function handleRemoveStudent() {
                const stationId = document.getElementById('station-id-input').value;
                delete appData.studentData[stationId];
                saveData();
                populateStudentData();
                studentModal.classList.add('hidden');
            }

            // --- Drag-to-Swap Handlers ---
            function handleDragStart(e) {
                if(e.target.classList.contains('student-station')){
                    draggedStationId = e.target.id;
                    isDragging = false;
                    e.preventDefault();
                }
            }
            function handleDragOver(e) {
                const targetStation = e.target.closest('.student-station');
                if (draggedStationId && targetStation) {
                    isDragging = true;
                    document.body.classList.add('dragging');
                    if (targetStation.id !== draggedStationId) {
                        targetStation.classList.add('drag-over');
                    }
                }
            }
            function handleDragOut(e) {
                const targetStation = e.target.closest('.student-station');
                if(targetStation) targetStation.classList.remove('drag-over');
            }
            function handleDrop(e) {
                const targetStation = e.target.closest('.student-station');
                if (isDragging && draggedStationId && targetStation && targetStation.id !== draggedStationId) {
                    const sourceData = appData.studentData[draggedStationId];
                    const targetData = appData.studentData[targetStation.id];
                    appData.studentData[draggedStationId] = targetData;
                    appData.studentData[targetStation.id] = sourceData;
                    saveData();
                    populateStudentData();
                }
                document.body.classList.remove('dragging');
                document.querySelectorAll('.student-station').forEach(s => s.classList.remove('drag-over'));
                draggedStationId = null;
                setTimeout(() => { isDragging = false; }, 50);
            }
            
            // --- Start the application ---
            init();
        });
    </script>

</body>
</html>

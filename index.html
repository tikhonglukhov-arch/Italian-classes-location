<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Classroom Tool</title>

    <!-- CSS STYLES -->
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --secondary-bg: #ffffff;
            --border-color: #d1d9e6;
            --primary-text: #333;
            --accent-color: #007bff;
            --desk-bg: #eef2f9;
            --danger-color: #dc3545;
        }

        /* --- General Setup --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        body.dragging {
            user-select: none;
        }

        /* --- Modals (Selection, Student) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--secondary-bg); padding: 40px; border-radius: 12px;
            text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%; width: 500px; position: relative;
        }
        #student-modal .modal-content { text-align: left; width: 400px; }
        
        .layout-choice { display: flex; gap: 20px; margin-top: 20px; justify-content: center; }
        .close-button {
            position: absolute; top: 10px; right: 15px; font-size: 28px;
            font-weight: bold; cursor: pointer; color: #aaa;
        }
        
        /* --- Main App Structure --- */
        .app-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 1400px; margin: auto; }
        
        /* Configuration Panels */
        .config-panel { background-color: var(--secondary-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .config-panel h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .input-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: center; }
        .input-group label { font-weight: 500; }
        .input-group input[type="number"] { width: 60px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        #row-inputs-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; border-left: 3px solid var(--accent-color); padding-left: 15px; }

        /* Classroom Container & Desk Styles from Project 1 */
        #classroom-container-parent {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
        }
        #classroom { 
            display: grid; grid-template-columns: 110px 1fr 110px; grid-template-rows: auto 1fr auto;
            width: 100%; max-width: 1200px; min-height: 70vh; margin: auto; background-color: #fffbe8;
            border: 2px solid #333; position: relative;
        }
        .wall { display: flex; justify-content: center; align-items: center; }
        .top-wall { grid-column: 1 / 4; grid-row: 1; padding: 15px; gap: 10px; flex-wrap: wrap; }
        .left-wall, .right-wall { grid-row: 2; flex-direction: column; justify-content: flex-start; gap: 15px; }
        .left-wall { grid-column: 1; padding-top: 10px; }
        .right-wall { grid-column: 3; padding-top: 0; }
        .bottom-wall { grid-column: 1 / 4; grid-row: 3; }
        .center-area { grid-column: 2; grid-row: 2; display: flex; justify-content: center; align-items: flex-end; }
        #teacher-desk { width: 100px; height: 50px; background-color: #a47449; color: white; display: flex; justify-content: center; align-items: center; border-radius: 5px; border: 2px solid #6b4b2c; }
        
        /* Standard Layout Container */
        #standard-layout-area { display: flex; flex-direction: column; gap: 20px; align-items: center; padding: 20px; background-color: #fffbe8; min-height: 70vh; border: 2px solid #333; border-radius: 12px; }
        .desk-row { display: flex; justify-content: center; gap: 15px; }
        
        .desk-pair { display: flex; gap: 4px; padding: 4px; background-color: #e0dcd1; border-radius: 5px; }
        .left-wall .desk-pair, .right-wall .desk-pair { flex-direction: column; }
        
        .student-station {
            width: 50px; height: 50px; background-color: var(--desk-bg); border: 1px solid var(--border-color); cursor: pointer;
            display: flex; justify-content: center; align-items: center; text-align: center;
            overflow: hidden; position: relative; background-size: cover; background-position: center;
            transition: border-color 0.2s;
        }
        .student-name { position: absolute; bottom: 1px; left: 0; right: 0; background-color: rgba(255, 255, 255, 0.75); padding: 1px 0; font-weight: bold; font-size: 10px; }
        .student-station.drag-over { border-color: #28a745; border-width: 2px; }
        
        /* Utility */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #classroom { display: flex; flex-direction: column; height: auto; min-height: 80vh; gap: 20px; }
            .wall { flex-wrap: wrap; }
            .left-wall .desk-pair, .right-wall .desk-pair { flex-direction: row; }
        }
    </style>
</head>
<body>

    <!-- 1. Initial Classroom Type Selection Screen -->
    <div id="selection-modal" class="modal">
        <div class="modal-content">
            <h2>Choose a Classroom Layout</h2>
            <div class="layout-choice">
                <button id="select-parliament" class="btn btn-primary">Parliament</button>
                <button id="select-standard" class="btn btn-primary">Standard</button>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <main class="app-container hidden" id="main-app">
        <!-- Configuration Panels -->
        <div class="config-panel hidden" id="parliament-config">
            <h3>Parliament Layout Configuration</h3>
            <div class="input-group">
                <div><label>Top Wall (Pairs):</label><input type="number" id="wall1-desks" value="7" min="0"></div>
                <div><label>Left Wall (Pairs):</label><input type="number" id="wall2-desks" value="3" min="0"></div>
                <div><label>Right Wall (Pairs):</label><input type="number" id="wall3-desks" value="4" min="0"></div>
            </div>
            <button id="reset-data-btn1" class="btn btn-danger">Reset All Data</button>
        </div>
        <div class="config-panel hidden" id="standard-config">
            <h3>Standard Layout Configuration</h3>
            <div class="input-group"><label>Total rows:</label><input type="number" id="total-rows" value="3" min="1"></div>
            <div id="row-inputs-container"></div>
            <button id="reset-data-btn2" class="btn btn-danger">Reset All Data</button>
        </div>

        <!-- Classroom Rendering Area -->
        <div id="classroom-container-parent">
            <div id="classroom-container">
                <!-- This will be dynamically filled -->
            </div>
        </div>
    </main>

    <!-- Student Info Modal (from Project 1) -->
    <div id="student-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Student Information</h3>
            <form id="student-form" style="display: flex; flex-direction: column; gap: 15px;">
                <input type="hidden" id="station-id-input">
                <div><label for="student-name">Name:</label><input type="text" id="student-name"></div>
                <div><label for="student-photo">Photo:</label><input type="file" id="student-photo" accept="image/*"></div>
                <div><label for="student-info">Notes:</label><textarea id="student-info" rows="3"></textarea></div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <button type="button" id="remove-student-btn" class="btn btn-danger">Remove Student</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Element References ---
            const mainApp = document.getElementById('main-app');
            const selectionModal = document.getElementById('selection-modal');
            const classroomContainer = document.getElementById('classroom-container');
            const studentModal = document.getElementById('student-modal');
            
            // Config Panels & Inputs
            const parliamentConfigPanel = document.getElementById('parliament-config');
            const standardConfigPanel = document.getElementById('standard-config');
            const wallInputs = [document.getElementById('wall1-desks'), document.getElementById('wall2-desks'), document.getElementById('wall3-desks')];
            const totalRowsInput = document.getElementById('total-rows');
            const rowInputsContainer = document.getElementById('row-inputs-container');
            
            // --- State Management ---
            let classroomData = {}; // Holds all data: layoutType, config, studentData
            let draggedStationId = null;
            let isDragging = false; // Differentiates a drag from a click for swapping

            // --- MAIN INITIALIZATION ---
            function init() {
                const savedData = localStorage.getItem('integratedClassroomData');
                if (savedData) {
                    classroomData = JSON.parse(savedData);
                    selectionModal.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    loadLayoutFromData();
                } else {
                    selectionModal.classList.remove('hidden');
                }
                addGlobalEventListeners();
            }

            function addGlobalEventListeners() {
                // Layout Selection
                document.getElementById('select-parliament').addEventListener('click', () => setupLayout('parliament'));
                document.getElementById('select-standard').addEventListener('click', () => setupLayout('standard'));

                // Reset Buttons
                document.getElementById('reset-data-btn1').addEventListener('click', resetAllData);
                document.getElementById('reset-data-btn2').addEventListener('click', resetAllData);
                
                // Config Inputs
                wallInputs.forEach(input => input.addEventListener('input', () => generateLayout('parliament', false)));
                totalRowsInput.addEventListener('input', () => {
                    updateRowInputs();
                    generateLayout('standard', false);
                });

                // Student Modal
                studentModal.querySelector('.close-button').addEventListener('click', () => studentModal.classList.add('hidden'));
                document.getElementById('student-form').addEventListener('submit', handleSaveStudent);
                document.getElementById('remove-student-btn').addEventListener('click', handleRemoveStudent);
            }
            
            // --- DATA & STATE FUNCTIONS ---
            function saveData() {
                // Before saving, ensure studentData only contains entries for existing desks
                const existingDeskIds = new Set(classroomData.config.desks.map(d => d.id));
                const filteredStudentData = {};
                for (const studentId in classroomData.studentData) {
                    if (existingDeskIds.has(studentId)) {
                        filteredStudentData[studentId] = classroomData.studentData[studentId];
                    }
                }
                classroomData.studentData = filteredStudentData;
                localStorage.setItem('integratedClassroomData', JSON.stringify(classroomData));
            }

            function resetAllData() {
                if (confirm("Are you sure? This will delete all saved layouts and student information.")) {
                    localStorage.removeItem('integratedClassroomData');
                    window.location.reload();
                }
            }
            
            // --- LAYOUT SETUP & GENERATION ---
            function loadLayoutFromData() {
                if (classroomData.layoutType === 'parliament') {
                    parliamentConfigPanel.classList.remove('hidden');
                    wallInputs[0].value = classroomData.config.wall1;
                    wallInputs[1].value = classroomData.config.wall2;
                    wallInputs[2].value = classroomData.config.wall3;
                } else {
                    standardConfigPanel.classList.remove('hidden');
                    totalRowsInput.value = classroomData.config.totalRows;
                    updateRowInputs(); // Create the input fields first
                    // Then populate them
                    document.querySelectorAll('.row-desk-input').forEach((input, index) => {
                        input.value = classroomData.config.rows[index];
                    });
                }
                generateLayout(classroomData.layoutType, false); // Regenerate structure and apply saved data
            }

            function setupLayout(type) {
                selectionModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                generateLayout(type, true);
            }

            function generateLayout(type, isFresh) {
                if (isFresh) {
                    classroomData = { layoutType: type, config: {}, studentData: {} };
                }
                classroomData.config.desks = []; // Reset desk list
                
                classroomContainer.innerHTML = ''; // Clear previous layout
                let stationCounter = 0;

                if (type === 'parliament') {
                    parliamentConfigPanel.classList.remove('hidden');
                    standardConfigPanel.classList.add('hidden');
                    classroomContainer.id = 'classroom'; // Use Project 1's ID and grid
                    
                    const [w1, w2, w3] = wallInputs.map(input => parseInt(input.value) || 0);
                    classroomData.config = { wall1: w1, wall2: w2, wall3: w3, desks: [] };

                    const topWall = createWall('top-wall');
                    for (let i = 0; i < w1; i++) topWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    
                    const leftWall = createWall('left-wall');
                    for (let i = 0; i < w2; i++) leftWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    
                    const rightWall = createWall('right-wall');
                    for (let i = 0; i < w3; i++) rightWall.appendChild(createDeskPair(stationCounter++, stationCounter++));
                    
                    classroomContainer.append(topWall, leftWall, rightWall, createWall('center-area', '<div id="teacher-desk">Cattedra</div>'), createWall('bottom-wall'));

                } else {
                    standardConfigPanel.classList.remove('hidden');
                    parliamentConfigPanel.classList.add('hidden');
                    classroomContainer.id = 'standard-layout-area';
                    
                    const rowInputs = document.querySelectorAll('.row-desk-input');
                    classroomData.config = { totalRows: rowInputs.length, rows: [], desks: [] };

                    rowInputs.forEach(input => {
                        const deskPairCount = parseInt(input.value) || 0;
                        classroomData.config.rows.push(deskPairCount);
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'desk-row';
                        for (let i = 0; i < deskPairCount; i++) {
                            rowDiv.appendChild(createDeskPair(stationCounter++, stationCounter++));
                        }
                        classroomContainer.appendChild(rowDiv);
                    });
                }

                // After creating the structure, register all desks and attach listeners
                classroomData.config.desks = Array.from(document.querySelectorAll('.student-station')).map(station => ({ id: station.id }));
                populateStudentData();
                attachDeskListeners();
                saveData();
            }

            function updateRowInputs() {
                const rowCount = parseInt(totalRowsInput.value) || 1;
                rowInputsContainer.innerHTML = '';
                for (let i = 1; i <= rowCount; i++) {
                    const div = document.createElement('div');
                    div.innerHTML = `<label>Desks (Pairs) in Row ${i}:</label><input type="number" class="row-desk-input" value="4" min="0">`;
                    rowInputsContainer.appendChild(div);
                }
                // Add listeners to new inputs
                document.querySelectorAll('.row-desk-input').forEach(input => input.addEventListener('input', () => generateLayout('standard', false)));
            }

            // --- Element Creation Helpers ---
            function createWall(className, innerHTML = '') {
                const wall = document.createElement('div');
                wall.className = `wall ${className}`;
                wall.innerHTML = innerHTML;
                return wall;
            }
            
            function createDeskPair(id1, id2) {
                const pair = document.createElement('div');
                pair.className = 'desk-pair';
                pair.appendChild(createStudentStation(id1));
                pair.appendChild(createStudentStation(id2));
                return pair;
            }

            function createStudentStation(id) {
                const station = document.createElement('div');
                station.className = 'student-station';
                station.id = `station-${id}`;
                return station;
            }

            // --- Data Population ---
            function populateStudentData() {
                const studentData = classroomData.studentData || {};
                document.querySelectorAll('.student-station').forEach(station => {
                    const data = studentData[station.id];
                    // Clear previous content
                    station.innerHTML = '';
                    station.style.backgroundImage = '';
                    if (data && data.name) {
                        if (data.photo) station.style.backgroundImage = `url(${data.photo})`;
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'student-name';
                        nameDiv.textContent = data.name;
                        station.appendChild(nameDiv);
                    }
                });
            }

            // --- Event Listeners Attachment ---
            function attachDeskListeners() {
                const stations = document.querySelectorAll('.student-station');
                stations.forEach(station => {
                    station.addEventListener('click', handleStationClick);
                    station.addEventListener('mousedown', handleDragStart);
                    station.addEventListener('mouseover', handleDragOver);
                    station.addEventListener('mouseout', handleDragOut);
                    station.addEventListener('mouseup', handleDrop);
                });

                const teacherDesk = document.getElementById('teacher-desk');
                if(teacherDesk) {
                    // This is a placeholder for future interactivity as per original skeleton
                    teacherDesk.addEventListener('click', () => { alert('Teacher Desk Clicked!'); });
                }
            }
            
            // --- Event Handlers (Student Interaction) ---
            function handleStationClick(e) {
                if (isDragging) return; // Prevent modal on drag-swap
                const station = e.currentTarget;
                const stationId = station.id;
                const data = classroomData.studentData[stationId] || {};
                
                document.getElementById('station-id-input').value = stationId;
                document.getElementById('student-name').value = data.name || '';
                document.getElementById('student-info').value = data.info || '';
                document.getElementById('student-photo').value = ''; // Clear file input
                studentModal.classList.remove('hidden');
            }

            function handleSaveStudent(e) {
                e.preventDefault();
                const stationId = document.getElementById('station-id-input').value;
                const photoFile = document.getElementById('student-photo').files[0];

                const studentInfo = {
                    name: document.getElementById('student-name').value.trim(),
                    info: document.getElementById('student-info').value.trim(),
                    photo: (classroomData.studentData[stationId] || {}).photo // Keep old photo unless new one is uploaded
                };
                
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        studentInfo.photo = event.target.result;
                        classroomData.studentData[stationId] = studentInfo;
                        saveData();
                        populateStudentData();
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    classroomData.studentData[stationId] = studentInfo;
                    saveData();
                    populateStudentData();
                }
                studentModal.classList.add('hidden');
            }

            function handleRemoveStudent() {
                const stationId = document.getElementById('station-id-input').value;
                delete classroomData.studentData[stationId];
                saveData();
                populateStudentData();
                studentModal.classList.add('hidden');
            }

            // --- Drag-to-Swap Handlers (from Project 1) ---
            function handleDragStart(e) {
                draggedStationId = e.currentTarget.id;
                isDragging = false; // Reset on new mousedown
                e.preventDefault();
            }

            function handleDragOver(e) {
                if (draggedStationId) {
                    isDragging = true;
                    document.body.classList.add('dragging');
                    const targetStation = e.currentTarget;
                    if (targetStation.id !== draggedStationId) {
                        targetStation.classList.add('drag-over');
                    }
                }
            }
            
            function handleDragOut(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            function handleDrop(e) {
                if (isDragging && draggedStationId) {
                    const targetStation = e.currentTarget;
                    if (targetStation.id !== draggedStationId) {
                        // Swap data
                        const sourceData = classroomData.studentData[draggedStationId];
                        const targetData = classroomData.studentData[targetStation.id];
                        classroomData.studentData[draggedStationId] = targetData;
                        classroomData.studentData[targetStation.id] = sourceData;
                        saveData();
                        populateStudentData();
                    }
                }
                // Cleanup regardless of whether it was a swap or not
                document.body.classList.remove('dragging');
                document.querySelectorAll('.student-station').forEach(s => s.classList.remove('drag-over'));
                draggedStationId = null;
                setTimeout(() => { isDragging = false; }, 50); // Timeout to prevent click event
            }
            
            // --- Start the application ---
            init();
        });
    </script>

</body>
</html>
